syntax = "proto3";

package simulation.v1;

option go_package = "github.com/GoSim-25-26J-441/simulation-core/proto/simulation/v1;simulationv1";

// SimulationService is the gRPC "CLI plane" API exposed by simd.
//
// The CLI (simulator-cli) talks to simd over gRPC for interactive management.
// The backend can optionally also use this, but the orchestrator plane is HTTP.
service SimulationService {
  // CreateRun registers a run and stores its inputs (scenario/config).
  rpc CreateRun(CreateRunRequest) returns (CreateRunResponse);

  // StartRun starts executing a previously created run.
  rpc StartRun(StartRunRequest) returns (StartRunResponse);

  // StopRun requests a graceful stop/cancel of a running run.
  rpc StopRun(StopRunRequest) returns (StopRunResponse);

  // GetRun returns run status and summary metadata.
  rpc GetRun(GetRunRequest) returns (GetRunResponse);

  // ListRuns returns recent runs (best-effort; pagination optional).
  rpc ListRuns(ListRunsRequest) returns (ListRunsResponse);

  // GetRunMetrics returns aggregated metrics for a completed (or running) run.
  rpc GetRunMetrics(GetRunMetricsRequest) returns (GetRunMetricsResponse);

  // StreamRunEvents streams lifecycle events for a run (status/metrics snapshots).
  rpc StreamRunEvents(StreamRunEventsRequest) returns (stream StreamRunEventsResponse);

  // UpdateWorkloadRate updates the request rate for a specific workload pattern in a running simulation.
  rpc UpdateWorkloadRate(UpdateWorkloadRateRequest) returns (UpdateWorkloadRateResponse);
}

// ---- Requests / responses

message CreateRunRequest {
  // Required.
  RunInput input = 1;

  // Optional. If set, server should use this as the run id (otherwise generate one).
  string run_id = 2;
}

message CreateRunResponse {
  Run run = 1;
}

message StartRunRequest {
  string run_id = 1;
}

message StartRunResponse {
  Run run = 1;
}

message StopRunRequest {
  string run_id = 1;
}

message StopRunResponse {
  Run run = 1;
}

message GetRunRequest {
  string run_id = 1;
}

message GetRunResponse {
  Run run = 1;
}

message ListRunsRequest {
  int32 limit = 1; // default server-side
}

message ListRunsResponse {
  repeated Run runs = 1;
}

message GetRunMetricsRequest {
  string run_id = 1;
}

message GetRunMetricsResponse {
  RunMetrics metrics = 1;
}

message StreamRunEventsRequest {
  string run_id = 1;

  // Optional: how often to emit metrics snapshots while running.
  int64 metrics_interval_ms = 2;
}

message StreamRunEventsResponse {
  RunEvent event = 1;
}

message UpdateWorkloadRateRequest {
  string run_id = 1;
  string pattern_key = 2;  // e.g., "client:svc1:/test"
  double rate_rps = 3;     // New rate in requests per second
}

message UpdateWorkloadRateResponse {
  Run run = 1;
}

// ---- Core models

message RunInput {
  // One of the following inputs should be provided.

  // Scenario YAML (the format used by config/scenario.yaml).
  string scenario_yaml = 1;

  // Optional additional config YAML (the format used by config/config.yaml).
  string config_yaml = 2;

  // Simulation duration override in milliseconds.
  // Clients should send a positive value to explicitly override the duration.
  // If 0 (the proto3 default) or unset at the client, the server uses scenario/config defaults.
  // Negative values are not valid and may be rejected by the server.
  int64 duration_ms = 3;

  // Deterministic seed (0 => server-generated).
  int64 seed = 4;

  // Real-time mode: if true, the simulation will throttle to run in real-time,
  // making it suitable for real-time dashboards and monitoring.
  // When false (default), the simulation runs as fast as possible.
  bool real_time_mode = 5;

  // When set, this run is an optimization experiment. The scenario_yaml is used
  // as the initial configuration; the orchestrator will run multiple simulations
  // to find a better configuration.
  OptimizationConfig optimization = 6;

  // Optional callback URL for completion notifications. When set, the server
  // POSTs run status to this URL on completion, failure, or cancellation.
  // Supports {run_id} placeholder (e.g. http://example.com/callback/{run_id}).
  string callback_url = 7;

  // Optional secret sent as X-Simulation-Callback-Secret header for callback auth.
  string callback_secret = 8;
}

// OptimizationConfig configures an optimization run (multi-run experiment).
message OptimizationConfig {
  // Objective function: p95_latency_ms, p99_latency_ms, mean_latency_ms,
  // throughput_rps, error_rate, cost.
  string objective = 1;

  // Maximum optimization iterations (default 10).
  int32 max_iterations = 2;

  // Step size for parameter exploration (default 1.0).
  double step_size = 3;
}

message Run {
  string id = 1;
  RunStatus status = 2;

  // Unix epoch milliseconds (UTC).
  int64 created_at_unix_ms = 3;
  int64 started_at_unix_ms = 4;
  int64 ended_at_unix_ms = 5;

  string error = 6;

  // For optimization runs: the best run ID and score found.
  string best_run_id = 7;
  double best_score = 8;
  int32 iterations = 9;
}

enum RunStatus {
  RUN_STATUS_UNSPECIFIED = 0;
  RUN_STATUS_PENDING = 1;
  RUN_STATUS_RUNNING = 2;
  RUN_STATUS_COMPLETED = 3;
  RUN_STATUS_FAILED = 4;
  RUN_STATUS_CANCELLED = 5;
}

message RunMetrics {
  int64 total_requests = 1;
  int64 successful_requests = 2;
  int64 failed_requests = 3;

  double latency_p50_ms = 4;
  double latency_p95_ms = 5;
  double latency_p99_ms = 6;
  double latency_mean_ms = 7;

  double throughput_rps = 8;

  repeated ServiceMetrics service_metrics = 9;
}

message ServiceMetrics {
  string service_name = 1;
  int64 request_count = 2;
  int64 error_count = 3;

  double latency_p50_ms = 4;
  double latency_p95_ms = 5;
  double latency_p99_ms = 6;
  double latency_mean_ms = 7;

  double cpu_utilization = 8;
  double memory_utilization = 9;
  int32 active_replicas = 10;
}

message RunEvent {
  // Unix epoch milliseconds (UTC).
  int64 at_unix_ms = 1;
  string run_id = 2;

  oneof event {
    RunStatusChanged status_changed = 3;
    MetricsSnapshot metrics_snapshot = 4;
    OptimizationProgress optimization_progress = 5;
  }
}

message RunStatusChanged {
  RunStatus previous = 1;
  RunStatus current = 2;
}

message MetricsSnapshot {
  RunMetrics metrics = 1;
}

// OptimizationProgress is emitted during optimization runs when iteration or best score changes.
message OptimizationProgress {
  int32 iteration = 1;
  double best_score = 2;
  string best_run_id = 3;
}


